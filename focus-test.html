<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Preservation Test - Croatian Working Law Fact Checker</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/neumorphism.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-neumorphic-outset);
        }
        .test-info {
            background: #e1f5fe;
            border: 1px solid #03a9f4;
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 1rem 0;
        }
        .test-status {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            margin: 0.5rem 0;
            font-weight: 600;
        }
        .test-pass {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .test-fail {
            background: #ffcdd2;
            color: #c62828;
        }
        .focus-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 0.5rem 1rem;
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-md);
            font-weight: 600;
            z-index: 1000;
        }
        .typing-simulation {
            font-family: monospace;
            background: #f5f5f5;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="focus-indicator" id="focus-indicator">Focus: Inactive</div>
    
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <h1>üîç Focus Preservation Test</h1>
                    <p>Testing search input focus behavior during real-time search</p>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="test-container">
            <div class="test-section">
                <h2>üéØ Focus Preservation Test</h2>
                <div class="test-info">
                    <strong>Test Instructions:</strong>
                    <ol>
                        <li>Click in the search box below</li>
                        <li>Start typing a search query (try "zakon", "work", "contract")</li>
                        <li>Continue typing WITHOUT pausing</li>
                        <li>The focus indicator should remain "Active" throughout</li>
                        <li>The cursor should stay in the input field</li>
                    </ol>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-input-wrapper neumorphic-panel">
                            <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M9.5 3A6.5 6.5 0 0 1 16 9.5C16 11.11 15.41 12.59 14.44 13.73L14.71 14H15.5L20.5 19L19 20.5L14 15.5V14.71L13.73 14.44C12.59 15.41 11.11 16 9.5 16A6.5 6.5 0 0 1 3 9.5A6.5 6.5 0 0 1 9.5 3M9.5 5C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/>
                            </svg>
                            <input 
                                type="search" 
                                class="neumorphic-input search-input" 
                                id="search-input"
                                placeholder="Type here to test focus preservation..."
                                aria-label="Search test input"
                                autocomplete="off"
                                autocorrect="off"
                                autocapitalize="off"
                                spellcheck="false"
                                data-preserve-focus="true"
                            >
                            <button class="neumorphic-circle small clear-search-btn" id="clear-search" aria-label="Clear search" style="display: none;">
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="test-section">
                <h3>üîç Search Results</h3>
                <div id="search-stats" style="display: none;">
                    Found <span id="results-count">0</span> results <span id="search-time">(0ms)</span>
                </div>
                <div id="results-container" class="results-container">
                    <!-- Search results will appear here -->
                </div>
                <div id="no-results" class="no-results" style="display: none;">
                    <p>No results found. Try a different search term.</p>
                </div>
            </div>

            <div class="test-section">
                <h3>üìä Test Results</h3>
                <div id="test-results">
                    <div class="test-status" id="focus-test-status">‚è≥ Waiting for test...</div>
                    <div class="typing-simulation" id="typing-log">Typing log will appear here...</div>
                </div>
            </div>

            <div class="test-section">
                <h3>üõ†Ô∏è Automatic Test</h3>
                <button class="neumorphic-btn" id="run-auto-test">Run Automatic Focus Test</button>
                <div id="auto-test-results" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </main>

    <script>
        // Focus tracking system
        let focusLostCount = 0;
        let typingEvents = [];
        let testStarted = false;

        const focusIndicator = document.getElementById('focus-indicator');
        const searchInput = document.getElementById('search-input');
        const focusTestStatus = document.getElementById('focus-test-status');
        const typingLog = document.getElementById('typing-log');

        // Track focus changes
        searchInput.addEventListener('focus', () => {
            focusIndicator.textContent = 'Focus: Active';
            focusIndicator.style.background = '#4caf50';
        });

        searchInput.addEventListener('blur', () => {
            focusIndicator.textContent = 'Focus: Lost';
            focusIndicator.style.background = '#f44336';
            
            if (testStarted) {
                focusLostCount++;
                updateTestStatus();
            }
        });

        // Track typing
        searchInput.addEventListener('input', (e) => {
            if (!testStarted && e.target.value.length > 0) {
                testStarted = true;
                focusTestStatus.textContent = 'üîÑ Test in progress...';
            }
            
            typingEvents.push({
                time: Date.now(),
                value: e.target.value,
                focused: document.activeElement === searchInput
            });
            
            updateTypingLog();
        });

        function updateTestStatus() {
            if (focusLostCount === 0) {
                focusTestStatus.className = 'test-status test-pass';
                focusTestStatus.textContent = `‚úÖ PASS: Focus preserved during typing (${typingEvents.length} keystrokes)`;
            } else {
                focusTestStatus.className = 'test-status test-fail';
                focusTestStatus.textContent = `‚ùå FAIL: Focus lost ${focusLostCount} times during typing`;
            }
        }

        function updateTypingLog() {
            const recent = typingEvents.slice(-5);
            const log = recent.map(event => 
                `"${event.value}" - ${event.focused ? '‚úÖ Focused' : '‚ùå Lost focus'}`
            ).join('\n');
            typingLog.textContent = log || 'No typing events yet...';
        }

        // Automatic test function
        document.getElementById('run-auto-test').addEventListener('click', async () => {
            const autoResults = document.getElementById('auto-test-results');
            autoResults.innerHTML = '<div class="test-status">‚è≥ Running automatic test...</div>';
            
            // Reset test state
            focusLostCount = 0;
            typingEvents = [];
            testStarted = false;
            
            // Focus input
            searchInput.focus();
            
            // Simulate typing with delays
            const testQuery = "zakon o radu employment contract";
            let currentValue = "";
            
            for (let i = 0; i < testQuery.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 100));
                currentValue += testQuery[i];
                
                // Simulate user input
                searchInput.value = currentValue;
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                
                // Check if focus was lost
                const stillFocused = document.activeElement === searchInput;
                if (!stillFocused) {
                    focusLostCount++;
                }
            }
            
            // Wait a moment for final results
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Display results
            if (focusLostCount === 0) {
                autoResults.innerHTML = `
                    <div class="test-status test-pass">
                        ‚úÖ AUTOMATIC TEST PASSED<br>
                        Typed ${testQuery.length} characters without losing focus
                    </div>
                `;
            } else {
                autoResults.innerHTML = `
                    <div class="test-status test-fail">
                        ‚ùå AUTOMATIC TEST FAILED<br>
                        Focus lost ${focusLostCount} times during typing
                    </div>
                `;
            }
        });

        // Initialize after DOM load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Focus test page loaded');
            // Auto-focus the input for immediate testing
            setTimeout(() => searchInput.focus(), 100);
        });
    </script>

    <!-- Load the search engine -->
    <script src="assets/js/database.js"></script>
    <script src="assets/js/search.js"></script>
    <script src="assets/js/main.js"></script>
</body>
</html>